name: Render Models with F3D

on:
  push:
    paths:
      - '**/*.py'
      - '.github/workflows/render_f3d.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      # 1. Install System Dependencies (F3D + Xvfb)
      #    uv manages Python, but F3D is a system binary we still need from apt.
      - name: Install System Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1 libgl1 libglx-mesa0

      # 2. Install F3D Manually (Direct Binary)
      - name: Install F3D v3.3.0 (Raytracing)
        run: |
          wget "https://github.com/f3d-app/f3d/releases/download/v3.3.0/F3D-3.3.0-Linux-x86_64-raytracing.tar.gz" -O f3d.tar.gz
          tar -xvf f3d.tar.gz
          # Move binary and libs to system locations so 'f3d' command works globally
          sudo cp -r F3D-3.3.0-Linux-x86_64-raytracing/* /usr/local/
          # prevent F3D images from being used later by commit renders by deleting F3D folder
          sudo rm -rf F3D-3.3.0-Linux-x86_64-raytracing/
          f3d --version
          f3d --help

      # 3. Setup uv
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "**/*.py" # Invalidate cache if python files change significantly

      # 4. Create Environment & Install Libraries
      - name: Install Python Dependencies
        run: |
          uv venv --python 3.12
          # Install build123d (and any other libs your models need)
          uv pip install build123d

      # 5. Generate Renders
      #    xvfb-run creates the virtual display.
      #    'uv run' ensures we use the python environment we just created.
      - name: Generate Renders
        run: xvfb-run -a uv run python .github/scripts/render_f3d.py

      # 6. Commit Images
      - name: Commit Renders
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ“¸ Auto-generate F3D renders"
          file_pattern: "**/*.png"
